<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/estilos.css">
    <!-- link das fontes do google fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&family=Press+Start+2P&family=Source+Code+Pro&display=swap" rel="stylesheet">
    <title>Consultar o CPF</title>
</head>
<body>
    <h1>Preencher Dados por CPF e Salvar</h1>
    <form id="meuFormulario">
        <div>
            <label for="cpf">CPF:</label>
            <input type="text" id="cpf" name="cpf" placeholder="Digite o CPF">
        </div>
        <div>
            <label for="nome">Nome:</label>
            <input type="text" id="nome" name="nome" readonly>
        </div>
        <div>
            <label for="cargo">Cargo:</label>
            <input type="text" id="cargo" name="cargo" readonly>
        </div>
        <div>
            <label>Municípios Vinculados:</label><br>
            <select id="municipio1" name="municipio1" disabled>
                <option value="">Selecione</option>
            </select>
            <select id="municipio2" name="municipio2" disabled>
                <option value="">Selecione</option>
            </select>
            <select id="municipio3" name="municipio3" disabled>
                <option value="">Selecione</option>
            </select>
            <select id="municipio4" name="municipio4" disabled>
                <option value="">Selecione</option>
            </select>
            <select id="municipio5" name="municipio5" disabled>
                <option value="">Selecione</option>
            </select>
        </div>
        <button type="button" onclick="salvarDadosSharePoint()">Salvar</button>
    </form>

    <script>
        document.getElementById('cpf').addEventListener('blur', function() {
            const cpfDigitado = this.value;
            if (cpfDigitado) {
                buscarDadosSharePoint(cpfDigitado);
            } else {
                limparFormulario();
            }
        });

        async function buscarDadosSharePoint(cpf) {
            const siteUrl = "SEU_SITE_SHAREPOINT";
            const listaPessoas = "NOME_DA_SUA_LISTA_PESSOAS";
            const campoCPF = "NomeDaColunaCPF";
            const campoNome = "NomeDaColunaNome";
            const campoCargo = "NomeDaColunaCargo";
            const endpointPessoas = ${siteUrl}/_api/web/lists/GetByTitle('${listaPessoas}')/items?$filter=${campoCPF} eq '${cpf}'&$select=${campoNome},${campoCargo};

            try {
                const responsePessoas = await fetch(endpointPessoas, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json;odata=nometadata',
                        // * Adicione aqui os cabeçalhos de autenticação necessários *
                    }
                });

                if (!responsePessoas.ok) {
                    throw new Error(Erro ao buscar dados da lista de pessoas: ${responsePessoas.status});
                }

                const dataPessoas = await responsePessoas.json();

                if (dataPessoas.value.length > 0) {
                    document.getElementById('nome').value = dataPessoas.value[0][campoNome];
                    const cargoEncontrado = dataPessoas.value[0][campoCargo];
                    document.getElementById('cargo').value = cargoEncontrado;
                    buscarMunicipiosPorCargo(cargoEncontrado);
                } else {
                    alert('CPF não encontrado na lista de pessoas.');
                    limparFormulario();
                }

            } catch (error) {
                console.error('Erro ao buscar dados do SharePoint (lista de pessoas):', error);
                alert('Ocorreu um erro ao buscar os dados da pessoa.');
                limparFormulario();
            }
        }

        async function buscarMunicipiosPorCargo(cargo) {
            const siteUrlLocal = "URL_DO_SEU_SITE_SHAREPOINT_LOCAL";
            const listaMunicipiosCargo = "NOME_DA_SUA_LISTA_MUNICIPIOS_CARGO";
            const campoCargoRelacao = "NomeDaColunaCargo";
            const campoMunicipio = "NomeDaColunaMunicipio";
            const endpointMunicipios = ${siteUrlLocal}/_api/web/lists/GetByTitle('${listaMunicipiosCargo}')/items?$filter=${campoCargoRelacao} eq '${cargo}'&$select=${campoMunicipio};

            try {
                const responseMunicipios = await fetch(endpointMunicipios, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json;odata=nometadata',
                        // * Adicione aqui os cabeçalhos de autenticação necessários *
                    }
                });

                if (!responseMunicipios.ok) {
                    throw new Error(Erro ao buscar municípios: ${responseMunicipios.status});
                }

                const dataMunicipios = await responseMunicipios.json();
                popularMunicipios(dataMunicipios.value);

            } catch (error) {
                console.error('Erro ao buscar municípios do SharePoint:', error);
                alert('Ocorreu um erro ao buscar os municípios.');
                desabilitarMunicipios();
            }
        }

        function popularMunicipios(municipios) {
            const selectsMunicipios = [
                document.getElementById('municipio1'),
                document.getElementById('municipio2'),
                document.getElementById('municipio3'),
                document.getElementById('municipio4'),
                document.getElementById('municipio5')
            ];

            selectsMunicipios.forEach(select => {
                select.innerHTML = '<option value="">Selecione</option>';
            });

            for (let i = 0; i < Math.min(municipios.length, selectsMunicipios.length); i++) {
                const option = document.createElement('option');
                option.value = municipios[i][campoMunicipio];
                option.textContent = municipios[i][campoMunicipio];
                selectsMunicipios[i].appendChild(option);
                selectsMunicipios[i].disabled = false;
            }

            for (let i = municipios.length; i < selectsMunicipios.length; i++) {
                selectsMunicipios[i].disabled = true;
            }
        }

        function desabilitarMunicipios() {
            const selectsMunicipios = [
                document.getElementById('municipio1'),
                document.getElementById('municipio2'),
                document.getElementById('municipio3'),
                document.getElementById('municipio4'),
                document.getElementById('municipio5')
            ];
            selectsMunicipios.forEach(select => {
                select.disabled = true;
                select.value = '';
                select.innerHTML = '<option value="">Selecione</option>';
            });
        }

        function limparFormulario() {
            document.getElementById('nome').value = '';
            document.getElementById('cargo').value = '';
            desabilitarMunicipios();
        }

        async function salvarDadosSharePoint() {
            const siteUrlResultado = "URL_DO_SEU_SITE_SHAREPOINT_RESULTADO"; // URL da lista "resultado"
            const listaResultadoNome = "resultado";
            const cpfValor = document.getElementById('cpf').value;
            const nomeValor = document.getElementById('nome').value;
            const cargoValor = document.getElementById('cargo').value;
            const municipio1Valor = document.getElementById('municipio1').value;
            const municipio2Valor = document.getElementById('municipio2').value;
            const municipio3Valor = document.getElementById('municipio3').value;
            const municipio4Valor = document.getElementById('municipio4').value;
            const municipio5Valor = document.getElementById('municipio5').value;

            const item = {
                'CPF': cpfValor,
                'Nome': nomeValor,
                'Cargo': cargoValor,
                'Municipio1': municipio1Valor,
                'Municipio2': municipio2Valor,
                'Municipio3': municipio3Valor,
                'Municipio4': municipio4Valor,
                'Municipio5': municipio5Valor
                // * Adapte os nomes das colunas da sua lista "resultado" aqui *
            };

            const endpointSalvar = ${siteUrlResultado}/_api/web/lists/GetByTitle('${listaResultadoNome}')/items;

            try {
                const responseSalvar = await fetch(endpointSalvar, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json;odata=nometadata',
                        'Content-Type': 'application/json;odata=nometadata',
                        // * Adicione aqui os cabeçalhos de autenticação necessários *
                    },
                    body: JSON.stringify(item)
                });

                if (!responseSalvar.ok) {
                    throw new Error(Erro ao salvar dados: ${responseSalvar.status});
                }

                alert('Dados salvos com sucesso!');
                // Opcional: Limpar o formulário após o sucesso
                document.getElementById('cpf').value = '';
                limparFormulario();

            } catch (error) {
                console.error('Erro ao salvar dados no SharePoint:', error);
                alert('Ocorreu um erro ao salvar os dados.');
            }
        }
    </script>
</body>
</html>